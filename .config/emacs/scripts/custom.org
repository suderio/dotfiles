#+title: Suderio's GNU Emacs Config - custom functions
#+AUTHOR: Paulo Suderio
#+DESCRIPTION: Suderio's personal Emacs config - Custom Code
#+STARTUP: showeverything
#+OPTIONS: toc:2
#+PROPERTY: header-args :tangle yes

* Custom Functions :toc:
  - [[#commit-and-push-git-config][Commit and push git config]]
  - [[#rotate-workorg][Rotate work.org]]

** Commit and push git config
#+begin_src shell :tangle ~/.bashrc.d/config-sync :shebang "#!/bin/bash"

# manage dotfiles with git, see https://www.atlassian.com/git/tutorials/dotfiles
alias config='/usr/bin/git --git-dir="$HOME"/.local/dotfiles/ --work-tree="$HOME"'

# Config in new machine
# git clone --bare git@github.com:suderio/dotfiles $HOME/.local/dotfiles
# config config --local status.showUntrackedFiles no
# config checkout
configsync () {
  configpath="${1:-$HOME}"
  config pull --all 
  config add -u "$configpath"
  config commit -m "config autocommit: $configpath" 
  config push
}

configstatus () {
  config status -s
}
#+end_src

#+begin_src emacs-lisp :tangle ./custom.el
(defun config-sync ()
  (interactive)
  (shell-command ". ~/.bashrc.d/config-sync ; configsync ~/.config/emacs"))

(defun config-status ()
  (interactive)
  (shell-command ". ~/.bashrc.d/config-sync ; configstatus"))
#+end_src
** Rotate work.org
#+begin_src emacs-lisp
(defun move-done-cancelled-tasks ()
  "Move DONE and CANCELLED tasks from work.org to the previous month's work-yyyymm.org file."
  (let* ((current-date (decode-time (current-time)))
         (year (nth 5 current-date))
         (month (nth 4 current-date))
         (prev-month (if (= month 1) 12 (1- month)))
         (prev-year (if (= prev-month 12) (1- year) year))
         (prev-file (format "work-%04d%02d.org" prev-year prev-month))
         (work-file "work.org")
         (prev-file-created nil))

    ;; Check if the previous month's file exists, if not, create it and mark as created
    (unless (file-exists-p prev-file)
      (with-temp-buffer (write-file prev-file))
      (setq prev-file-created t))

    ;; If the previous month's file was created, move DONE and CANCELLED tasks
    (when prev-file-created
      (with-current-buffer (find-file-noselect work-file)
        (goto-char (point-min))
        (let ((case-fold-search t)
              (org-refile-targets `((,prev-file :maxlevel . 1)))
              (org-refile-allow-creating-parent-nodes t)
              (tasks-to-move nil))
          
          ;; Collect DONE and CANCELLED tasks
          (while (re-search-forward "^\\*+ \\(DONE\\|CANCELLED\\) " nil t)
            (let ((pos (point)))
              (push (list nil work-file nil pos) tasks-to-move)))
          
          ;; Refile tasks
          (dolist (task tasks-to-move)
            (goto-char (nth 3 task))
            (org-refile nil nil (list nil prev-file nil (point-max)))))

        (save-buffer)))))

;; (move-done-cancelled-tasks)

#+end_src
